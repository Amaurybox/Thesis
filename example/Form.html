<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tangle project</title>
    <link rel="stylesheet" href="Style.css">
</head>
<body>

<div class="form-style-6">
    <h1>Retrieve Data</h1>
    <form method="POST" action="new.cgi" onsubmit="test()">
        <input type="text" name="field1" placeholder="Root" />
        <input type="text" name="field2" placeholder="Provider" />
        <input type="text" name="field3" placeholder="Mode"/>
        <input type="submit" value="Fetch" />
    </form>
</div>
<div id="output">
    <script src="../lib/mam.web.min.js"></script>
    <script>
        const TRYTE_ALPHABET = '9ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        const asciiToTrytes = (input) => {
            let trytes = '';
            for (let i = 0; i < input.length; i++) {
                var dec = input[i].charCodeAt(0);
                trytes += TRYTE_ALPHABET[dec % 27];
                trytes += TRYTE_ALPHABET[(dec - dec % 27) / 27];
            }
            return trytes;
        };

        const trytesToAscii = (trytes) => {
            let ascii = '';
            for (let i = 0; i < trytes.length; i += 2) {
                ascii += String.fromCharCode(TRYTE_ALPHABET.indexOf(trytes[i]) + TRYTE_ALPHABET.indexOf(trytes[i + 1]) * 27);
            }
            return ascii;
        };

        (async function () {
            const mode = 'public'
            const provider = 'https://nodes.devnet.iota.org'

            const mamExplorerLink = `https://mam-explorer.firebaseapp.com/?provider=${encodeURIComponent(provider)}&mode=${mode}&root=`

            const outputHtml = document.querySelector("#output");

            // Initialise MAM State
            let mamState = Mam.init(provider)

            // Publish to tangle
            const publish = async packet => {
                // Create MAM Payload - STRING OF TRYTES
                const trytes = asciiToTrytes(JSON.stringify(packet))
                const message = Mam.create(mamState, trytes)

                // Save new mamState
                mamState = message.state

                // Attach the payload
                await Mam.attach(message.payload, message.address, 3, 9)

                outputHtml.innerHTML += `Published: ${packet}<br/>`;
                return message.root
            }

            const publishAll = async () => {
                const root = await publish('cc')

                await publish('BOB')

                await publish('CHARLIE')

                return root
            }

            // Callback used to pass data out of the fetch
            //const logData = data => outputHtml.innerHTML += `Fetched and parsed ${JSON.parse(trytesToAscii(data))}<br/>`;

            //const root = await publishAll();
            const root= "CI9UNGEJPMOJGVICBMLXYBFYXAVANNTQ9O9JRBLRWIBF9NTENWTHXHHMI9FPVLYDUJKOJCCKWXCEJUXO9" ;

            // Output asyncronously using "logData" callback function
            //await Mam.fetch(root, mode, null, logData)

            // Output syncronously once fetch is completed
            const result = await Mam.fetch(root, mode)
            result.messages.forEach(message => {
                    outputHtml.innerHTML += `Fetched and parsed ${JSON.parse(trytesToAscii(message))}<br/>`
            });

                outputHtml.innerHTML += `Verify with MAM Explorer:<br/><a target="_blank" href="${mamExplorerLink}${root}">${mamExplorerLink}${root}</a>`;
            })();

    </script>
</div>

</body>
</html>
